<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gemini API Key Checker - 控制台</title>
    <!-- Bootstrap CSS 主CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" onerror="this.onerror=null; document.head.appendChild(Object.assign(document.createElement('link'), {rel:'stylesheet', href:'/static/css/local-bootstrap.css'}));">
    <!-- Bootstrap 图标 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet" onerror="this.onerror=null; console.log('Bootstrap图标CDN加载失败，使用本地emoji备用方案');">
    <!-- 备用CDN -->
    <link href="https://unpkg.com/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" onerror="this.remove();">
    <!-- 本地备用样式 + 自定义样式 -->
    <link href="/static/css/local-bootstrap.css" rel="stylesheet">
    <link href="/static/css/app.css" rel="stylesheet">
    <style>
        body { background-color: #f5f7fb; }
        .sidebar { min-height: calc(100vh - 56px); background: #ffffff; box-shadow: 0 6px 18px rgba(0,0,0,.06); border-right: 1px solid rgba(0,0,0,.05); }
        .sidebar .nav-link { color: #444; border-radius: 8px; margin: 2px 8px; }
        .sidebar .nav-link.active { background: rgba(13,110,253,.1); color: #0d6efd; font-weight: 600; }
        .brand { font-weight: 700; letter-spacing: .3px; }
        .content-wrapper { padding: 20px; }
        .section-title { font-weight: 600; }
        .log-container { height: 380px; overflow-y: auto; background: #0e0f13; color: #e5e7eb; border-radius: 12px; padding: 14px; font-family: 'Courier New', monospace; }
        .status-badge { font-size: .8rem; }
        .stat-card { border: 0; border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,.06); }
        .stat-card .value { font-size: 1.8rem; font-weight: 700; }
        .stat-icon { font-size: 1.2rem; opacity: .75; }
        .progress.thin { height: 8px; border-radius: 6px; }
        .key-display { font-family: 'Courier New', monospace; word-break: break-all; }
        .toolbar .btn { min-width: 40px; }
        .table thead th { border-top: 0; }
    </style>
</head>
<body>
    <!-- 顶部导航 -->
    <nav class="navbar navbar-dark" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="container-fluid">
            <span class="navbar-brand brand"><i class="bi bi-key"></i> Gemini API Key Checker</span>
            <div class="d-flex align-items-center gap-2">
                <small id="statusText" class="text-white-50">系统运行中...</small>
                <button class="btn btn-sm btn-light" id="action-open-settings" title="设置"><i class="bi bi-gear"></i></button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- 左侧侧边栏 -->
            <aside class="col-12 col-md-2 sidebar glass rounded-3 my-3 py-3">
                <nav class="nav flex-column">
                    <a class="nav-link active" href="#section-dashboard"><i class="bi bi-speedometer2 me-2"></i>仪表盘</a>
                    <a class="nav-link" href="#section-keys"><i class="bi bi-list me-2"></i>密钥列表</a>
                    <a class="nav-link" href="#section-logs"><i class="bi bi-terminal me-2"></i>实时日志</a>
                </nav>
                <hr/>
                                    <div class="px-2">
                    <div class="d-grid gap-2">
                        <button id="action-check-all" class="btn btn-primary"><i class="bi bi-search"></i> 检测所有</button>
                        <button id="action-check-pending" class="btn btn-info"><i class="bi bi-hourglass-split"></i> 只检测待检测</button>
                        <button id="action-force-check" class="btn btn-warning"><i class="bi bi-lightning"></i> 强制全量</button>
                        <button id="action-stop" class="btn btn-danger"><i class="bi bi-stop-fill"></i> 停止检测</button>
                    </div>
                </div>
                <hr/>
                                    <div class="px-2 d-grid gap-2">
                    <button id="action-copy-valid-lines" class="btn btn-success"><i class="bi bi-clipboard-check"></i> 复制有效key(换行形式)</button>
                    <button id="action-copy-valid-comma" class="btn btn-success"><i class="bi bi-clipboard"></i> 复制有效key(逗号形式)</button>
                    <button id="action-delete-invalid" class="btn btn-danger"><i class="bi bi-trash"></i> 删除无效key</button>
                </div>
            </aside>

            <!-- 右侧主内容 -->
            <main class="col-12 col-md-10 content-wrapper my-3">
                <!-- 仪表盘部分 -->
                <section id="section-dashboard" class="mb-4">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <h5 class="section-title mb-0">仪表盘</h5>
                        <div class="toolbar d-flex gap-2">
                            <button class="btn btn-secondary" id="action-clear-logs" title="清空日志"><i class="bi bi-trash"></i></button>
                            <button class="btn btn-secondary" id="action-scroll-bottom" title="滚动到底部"><i class="bi bi-arrow-down"></i></button>
                        </div>
                    </div>

                    <!-- 统计卡片 -->
                    <div class="row g-3 mb-3">
                        <div class="col-12 col-sm-6 col-lg-3">
                            <div class="card stat-card p-3">
                                <div class="d-flex align-items-center justify-content-between">
                                    <span class="text-muted">有效密钥</span>
                                    <i class="bi bi-check-circle text-success stat-icon"></i>
                                </div>
                                <div class="value text-success" id="validCount">{{ stats.valid_count }}</div>
                            </div>
                        </div>
                        <div class="col-12 col-sm-6 col-lg-3">
                            <div class="card stat-card p-3">
                                <div class="d-flex align-items-center justify-content-between">
                                    <span class="text-muted">无效密钥</span>
                                    <i class="bi bi-x-circle text-danger stat-icon"></i>
                                </div>
                                <div class="value text-danger" id="invalidCount">{{ stats.invalid_count }}</div>
                            </div>
                        </div>
                        <div class="col-12 col-sm-6 col-lg-3">
                            <div class="card stat-card p-3">
                                <div class="d-flex align-items-center justify-content-between">
                                    <span class="text-muted">待检测</span>
                                    <i class="bi bi-hourglass-split text-warning stat-icon"></i>
                                </div>
                                <div class="value text-warning" id="pendingCount">{{ stats.pending_count }}</div>
                            </div>
                        </div>
                        <div class="col-12 col-sm-6 col-lg-3">
                            <div class="card stat-card p-3">
                                <div class="d-flex align-items-center justify-content-between">
                                    <span class="text-muted">处理进度</span>
                                    <i class="bi bi-bar-chart-line stat-icon"></i>
                                </div>
                                <div class="progress thin mt-2">
                                    <div id="statProgressFill" class="progress-bar bg-primary" style="width: 0%"></div>
                                </div>
                                <div class="d-flex justify-content-between mt-2">
                                    <small class="text-success">有效 <span id="validPercent">0%</span></small>
                                    <small class="text-danger">无效 <span id="invalidPercent">0%</span></small>
                                </div>
                        </div>
                    </div>
                </div>

                    <!-- 添加密钥卡片 -->
                <div class="card mb-4">
                        <div class="card-header bg-white">
                            <h6 class="mb-0"><i class="bi bi-plus-circle"></i> 添加密钥</h6>
                    </div>
                    <div class="card-body">
                        <form id="addKeyForm">
                            <div class="form-floating mb-3">
                                <textarea class="form-control" id="newKeys" placeholder="请输入密钥"></textarea>
                                    <label for="newKeys">密钥列表（每行一个，或用逗号分隔）</label>
                            </div>
                            <div class="form-text mb-3">
                                    💡 支持多种格式，自动去除多余空格和末尾逗号
                            </div>
                                <div class="d-grid d-sm-flex gap-2">
                                    <button type="submit" class="btn btn-primary"><i class="bi bi-check-circle"></i> 添加并检测</button>
                                    <button type="button" class="btn btn-secondary" onclick="window.checkAllKeys()"><i class="bi bi-arrow-clockwise"></i> 按策略检测</button>
                            </div>
                        </form>
                    </div>
                </div>

                    <!-- 检测状态与日志 -->
                    <div class="row g-3" id="section-logs">
                        <div class="col-12">
                            <div class="card mb-3">
                                <div class="card-header bg-white d-flex align-items-center justify-content-between">
                                    <h6 class="mb-0"><i class="bi bi-activity"></i> 检测状态</h6>
                                    <button id="stop-check-btn" type="button" class="btn btn-danger btn-sm" onclick="window.stopChecking()">
                                        <i class="bi bi-stop-fill"></i> 停止
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="status-idle" class="text-muted"><i class="bi bi-check-circle"></i> 空闲状态</div>
                                    <div id="status-checking" class="text-primary d-none">
                                        <div class="d-flex align-items-center">
                                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                            <div>
                                                <div id="check-type">正在检测...</div>
                                                <small id="check-duration" class="text-muted">运行时间: 0秒</small>
                                                <div id="stop-status" class="text-warning d-none"><small><i class="bi bi-exclamation-triangle"></i> 正在停止...</small></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="bi bi-terminal"></i> 实时日志</h6>
                                    <small class="text-muted" id="logStatus">日志流连接中...</small>
                                </div>
                                <div class="card-body p-0">
                                    <div id="logContainer" class="log-container"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 密钥列表 -->
                <section id="section-keys" class="mt-4">
                    <div class="card">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="bi bi-list"></i> 密钥列表</h6>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-primary" onclick="window.refreshKeyList()"><i class="bi bi-arrow-clockwise"></i> 刷新</button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>密钥</th>
                                            <th>状态</th>
                                            <th>最后检测</th>
                                            <th>错误信息</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="keyTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- 设置模态框 -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">系统设置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                        <form id="scheduleForm">
                        <div class="row g-3">
                            <div class="col-12 col-md-6">
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="intervalMinutes" value="{{ settings.check_interval or 60 }}" min="0" step="1" />
                                <label for="intervalMinutes">检测间隔（分钟，0=禁用）</label>
                                </div>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="concurrency" value="{{ settings.concurrency or 10 }}" min="1" step="1" />
                                    <label for="concurrency">并发检测数（≥1，建议量力而行）</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">🌐 API端点设置</label>
                                <div class="form-floating mb-2">
                                    <input type="text" class="form-control" id="apiUrl" value="{{ settings.api_url or '' }}" placeholder="留空使用Google官方API" />
                                    <label for="apiUrl">自定义API URL</label>
                                </div>
                                <div class="form-text">留空默认使用Google官方API端点，支持自定义API服务器</div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">🔗 代理设置</label>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="useProxy" {{ 'checked' if settings.use_proxy != 'false' else '' }} />
                                    <label class="form-check-label" for="useProxy">启用代理</label>
                                </div>
                                <div class="form-floating" id="proxyUrlContainer">
                                    <input type="text" class="form-control" id="proxyUrl" value="{{ settings.proxy_url or 'http://127.0.0.1:7890' }}" />
                                    <label for="proxyUrl">代理地址</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-floating">
                                <select class="form-select" id="checkStrategy">
                                        <option value="all" {{ 'selected' if settings.check_strategy == 'all' else '' }}>全量检测（有效+待检测密钥）</option>
                                        <option value="incremental" {{ 'selected' if settings.check_strategy == 'incremental' else '' }}>增量检测（24小时内未检测的有效密钥）</option>
                                </select>
                                <label for="checkStrategy">检测策略</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">📧 邮件通知设置</label>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="emailEnabled" {{ 'checked' if settings.email_enabled == 'true' else '' }} />
                                    <label class="form-check-label" for="emailEnabled">启用邮件通知</label>
                                </div>
                                <div id="emailConfigContainer">
                                    <div class="mb-2"><small class="text-muted">已设置邮箱数量: <span id="emailCount" class="badge bg-secondary">0</span></small></div>
                                    <div class="form-floating mb-2">
                                        <input type="email" class="form-control email-input" id="email1" value="{{ settings.email1 or '' }}" placeholder="邮箱地址1" />
                                        <label for="email1">邮箱地址1</label>
                                    </div>
                                    <div class="form-floating mb-2">
                                        <input type="email" class="form-control email-input" id="email2" value="{{ settings.email2 or '' }}" placeholder="邮箱地址2" />
                                        <label for="email2">邮箱地址2</label>
                                    </div>
                                    <div class="form-floating mb-2">
                                        <input type="email" class="form-control email-input" id="email3" value="{{ settings.email3 or '' }}" placeholder="邮箱地址3" />
                                        <label for="email3">邮箱地址3</label>
                                    </div>
                                    <div class="form-floating mb-2">
                                        <input type="password" class="form-control" id="emailPassword" value="{{ settings.email_password or '' }}" placeholder="Gmail应用密码" />
                                        <label for="emailPassword">Gmail应用密码</label>
                            </div>
                            <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-info btn-sm" onclick="window.sendTestEmail()"><i class="bi bi-envelope-check"></i> 发送测试邮件</button>
                                    </div>
                                </div>
                                <div class="form-text mt-2">发送邮箱: aa1xuyuhuayhm@gmail.com，需要在Gmail中生成应用密码用于SMTP认证</div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-success" id="action-save-settings"><i class="bi bi-gear"></i> 保存设置</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JS 资源 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" onerror="console.log('Bootstrap JS CDN加载失败')"></script>
    <script src="https://unpkg.com/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" onerror="this.remove()"></script>
    <!-- 应用脚本（重构） -->
    <script src="/static/js/app.js"></script>
</body>
</html> 