<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini API Key Checker - å¯†é’¥æ£€æµ‹ç®¡ç†ç³»ç»Ÿ</title>
    <!-- Bootstrap CSS ä¸»CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" onerror="this.onerror=null; document.head.appendChild(Object.assign(document.createElement('link'), {rel:'stylesheet', href:'/static/css/local-bootstrap.css'}));">
    <!-- Bootstrap å›¾æ ‡ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet" onerror="this.onerror=null; console.log('Bootstrapå›¾æ ‡CDNåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°emojiå¤‡ç”¨æ–¹æ¡ˆ');">
    <!-- å¤‡ç”¨CDN -->
    <link href="https://unpkg.com/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" onerror="this.remove();">
    <!-- æœ¬åœ°å¤‡ç”¨æ ·å¼ -->
    <link href="/static/css/local-bootstrap.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .navbar-brand { font-weight: bold; }
        .card { box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); }
        .log-container { 
            height: 400px; 
            overflow-y: auto; 
            background: #000; 
            color: #fff; 
            font-family: 'Courier New', monospace; 
            padding: 15px;
            border-radius: 5px;
        }
        .log-entry { margin-bottom: 5px; }
        .log-info { color: #17a2b8; }
        .log-error { color: #dc3545; }
        .log-success { color: #28a745; }
        .log-progress { 
            color: #0d6efd; 
            font-family: 'Courier New', monospace; 
            font-weight: bold; 
            background-color: #f8f9fa; 
            padding: 2px 6px; 
            border-radius: 4px;
            display: inline-block;
        }
        .status-badge { font-size: 0.8em; }
        .key-display { 
            font-family: 'Courier New', monospace; 
            word-break: break-all;
        }
        .stats-card { text-align: center; }
        .form-floating textarea { min-height: 120px; }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-key"></i> Gemini API Key Checker
            </span>
            <span class="navbar-text">
                <small id="statusText">ç³»ç»Ÿè¿è¡Œä¸­...</small>
            </span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
            <div class="col-md-4">
                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-bar-chart"></i> ç»Ÿè®¡ä¿¡æ¯</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4 stats-card">
                                <h4 class="text-success" id="validCount">627</h4>
                                <small class="text-muted">æœ‰æ•ˆå¯†é’¥</small>
                            </div>
                            <div class="col-4 stats-card">
                                <h4 class="text-danger" id="invalidCount">91</h4>
                                <small class="text-muted">æ— æ•ˆå¯†é’¥</small>
                            </div>
                            <div class="col-4 stats-card">
                                <h4 class="text-warning" id="pendingCount">0</h4>
                                <small class="text-muted">å¾…æ£€æµ‹</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ·»åŠ å¯†é’¥ -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-plus-circle"></i> æ·»åŠ å¯†é’¥</h5>
                    </div>
                    <div class="card-body">
                        <form id="addKeyForm">
                            <div class="form-floating mb-3">
                                <textarea class="form-control" id="newKeys" placeholder="è¯·è¾“å…¥å¯†é’¥"></textarea>
                                <label for="newKeys">å¯†é’¥åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
                            </div>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-circle"></i> æ·»åŠ å¹¶æ£€æµ‹
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="checkAllKeys()">
                                    <i class="bi bi-arrow-clockwise"></i> æŒ‰ç­–ç•¥æ£€æµ‹å¯†é’¥
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- å®šæ—¶è®¾ç½® -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-clock"></i> å®šæ—¶è®¾ç½®</h5>
                    </div>
                    <div class="card-body">
                        <form id="scheduleForm">
                            <div class="form-floating mb-3">
                                <input type="number" class="form-control" id="intervalMinutes" 
                                       value="30" min="0" step="1">
                                <label for="intervalMinutes">æ£€æµ‹é—´éš”ï¼ˆåˆ†é’Ÿï¼Œ0=ç¦ç”¨ï¼‰</label>
                            </div>
                            
                            <!-- APIç«¯ç‚¹è®¾ç½® -->
                            <div class="mb-3">
                                <label class="form-label">ğŸŒ APIç«¯ç‚¹è®¾ç½®</label>
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="apiUrl" 
                                           value="" 
                                           placeholder="ç•™ç©ºä½¿ç”¨Googleå®˜æ–¹API">
                                    <label for="apiUrl">è‡ªå®šä¹‰API URL</label>
                                </div>
                                <div class="form-text">
                                    ç•™ç©ºé»˜è®¤ä½¿ç”¨Googleå®˜æ–¹APIç«¯ç‚¹ï¼Œæ”¯æŒè‡ªå®šä¹‰APIæœåŠ¡å™¨
                                </div>
                            </div>
                            
                            <!-- ä»£ç†è®¾ç½® -->
                            <div class="mb-3">
                                <label class="form-label">ğŸ”— ä»£ç†è®¾ç½®</label>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="useProxy" 
                                           checked>
                                    <label class="form-check-label" for="useProxy">
                                        å¯ç”¨ä»£ç†
                                    </label>
                                </div>
                                <div class="form-floating" id="proxyUrlContainer">
                                    <input type="text" class="form-control" id="proxyUrl" 
                                           value="http://127.0.0.1:7890">
                                    <label for="proxyUrl">ä»£ç†åœ°å€</label>
                                </div>
                            </div>
                            
                            <div class="form-floating mb-3">
                                <input type="number" class="form-control" id="concurrency" 
                                       value="10" min="1" max="100" step="1">
                                <label for="concurrency">å¹¶å‘æ£€æµ‹æ•°ï¼ˆ1-100ï¼‰</label>
                            </div>
                            <div class="form-floating mb-3">
                                <select class="form-select" id="checkStrategy">
                                    <option value="all" selected>
                                        å…¨é‡æ£€æµ‹ï¼ˆæœ‰æ•ˆ+å¾…æ£€æµ‹å¯†é’¥ï¼‰
                                    </option>
                                    <option value="incremental" >
                                        å¢é‡æ£€æµ‹ï¼ˆ24å°æ—¶å†…æœªæ£€æµ‹çš„æœ‰æ•ˆå¯†é’¥ï¼‰
                                    </option>
                                </select>
                                <label for="checkStrategy">æ£€æµ‹ç­–ç•¥</label>
                            </div>
                            
                            <!-- é‚®ä»¶é€šçŸ¥è®¾ç½® -->
                            <div class="mb-3">
                                <label class="form-label">ğŸ“§ é‚®ä»¶é€šçŸ¥è®¾ç½®</label>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="emailEnabled" 
                                           checked>
                                    <label class="form-check-label" for="emailEnabled">
                                        å¯ç”¨é‚®ä»¶é€šçŸ¥
                                    </label>
                                </div>
                                <div id="emailConfigContainer">
                                    <!-- é‚®ç®±æ•°é‡æ˜¾ç¤º -->
                                    <div class="mb-2">
                                        <small class="text-muted">å·²è®¾ç½®é‚®ç®±æ•°é‡: <span id="emailCount" class="badge bg-secondary">0</span></small>
                                    </div>
                                    
                                    <!-- 3ä¸ªå¹³ç­‰çš„é‚®ç®±é…ç½® -->
                                    <div class="form-floating mb-2">
                                        <input type="email" class="form-control email-input" id="email1" 
                                               value="yhm200618@163.com" 
                                               placeholder="é‚®ç®±åœ°å€1">
                                        <label for="email1">é‚®ç®±åœ°å€1</label>
                                    </div>
                                    
                                    <div class="form-floating mb-2">
                                        <input type="email" class="form-control email-input" id="email2" 
                                               value="2097627409@qq.com" 
                                               placeholder="é‚®ç®±åœ°å€2">
                                        <label for="email2">é‚®ç®±åœ°å€2</label>
                                    </div>
                                    
                                    <div class="form-floating mb-2">
                                        <input type="email" class="form-control email-input" id="email3" 
                                               value="" 
                                               placeholder="é‚®ç®±åœ°å€3">
                                        <label for="email3">é‚®ç®±åœ°å€3</label>
                                    </div>
                                    
                                    <div class="form-floating mb-2">
                                        <input type="password" class="form-control" id="emailPassword" 
                                               value="qkuk zryd fcny qkxw" 
                                               placeholder="Gmailåº”ç”¨å¯†ç ">
                                        <label for="emailPassword">Gmailåº”ç”¨å¯†ç </label>
                                    </div>
                                    <div class="d-grid gap-2 mb-2">
                                        <button type="button" class="btn btn-outline-info btn-sm" onclick="sendTestEmail()">
                                            <i class="bi bi-envelope-check"></i> å‘é€æµ‹è¯•é‚®ä»¶ï¼ˆå·²è®¾ç½®çš„é‚®ç®±ï¼‰
                                        </button>
                                    </div>
                                </div>
                                <div class="form-text">
                                    å‘é€é‚®ç®±: aa1xuyuhuayhm@gmail.com<br>
                                    éœ€è¦åœ¨Gmailä¸­ç”Ÿæˆåº”ç”¨å¯†ç ç”¨äºSMTPè®¤è¯
                                </div>
                            </div>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-gear"></i> ä¿å­˜è®¾ç½®
                                </button>
                                <button id="check-all-btn" type="button" class="btn btn-primary" onclick="checkAllKeys()">
                                    ğŸ” æ£€æµ‹æ‰€æœ‰å¯†é’¥
                                </button>
                                <button id="force-check-btn" type="button" class="btn btn-warning" onclick="checkAllKeys(true)">
                                    ğŸ”¥ å¼ºåˆ¶å…¨é‡æ£€æµ‹
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ä¸»è¦å†…å®¹ -->
            <div class="col-md-8">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h5>
                                <div id="stats-content">
                                    <p class="mb-1">æ€»å¯†é’¥æ•°: <span id="total-keys"></span></p>
                                    <p class="mb-1">æœ‰æ•ˆå¯†é’¥: <span id="valid-keys" class="text-success"></span></p>
                                    <p class="mb-1">æ— æ•ˆå¯†é’¥: <span id="invalid-keys" class="text-danger"></span></p>
                                    <p class="mb-0">å¾…æ£€æµ‹: <span id="pending-keys" class="text-warning"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">ğŸ” æ£€æµ‹çŠ¶æ€</h5>
                                <div id="check-status-content">
                                    <div id="status-idle" class="text-muted">
                                        <i class="bi bi-check-circle"></i> ç©ºé—²çŠ¶æ€
                                    </div>
                                    <div id="status-checking" class="text-primary d-none">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center">
                                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                                <div>
                                                    <div id="check-type">æ­£åœ¨æ£€æµ‹...</div>
                                                    <small id="check-duration" class="text-muted">è¿è¡Œæ—¶é—´: 0ç§’</small>
                                                    <div id="stop-status" class="text-warning d-none">
                                                        <small><i class="bi bi-exclamation-triangle"></i> æ­£åœ¨åœæ­¢...</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <button id="stop-check-btn" type="button" class="btn btn-danger btn-sm" onclick="stopChecking()">
                                                <i class="bi bi-stop-fill"></i> åœæ­¢
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å®æ—¶æ—¥å¿— -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-terminal"></i> å®æ—¶æ—¥å¿—</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearLogs()">
                                <i class="bi bi-trash"></i> æ¸…ç©º
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="scrollToBottom()">
                                <i class="bi bi-arrow-down"></i> æ»šåŠ¨åˆ°åº•éƒ¨
                            </button>
                            <small class="text-muted ms-2" id="logStatus">æ—¥å¿—æµè¿æ¥ä¸­...</small>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="logContainer" class="log-container"></div>
                    </div>
                </div>

                <!-- å¯†é’¥åˆ—è¡¨ -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-list"></i> å¯†é’¥åˆ—è¡¨</h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-success" onclick="copyValidKeys('lines')" title="å¤åˆ¶æœ‰æ•ˆå¯†é’¥ï¼ˆæ¢è¡Œåˆ†éš”ï¼‰">
                                <i class="bi bi-copy"></i> å¤åˆ¶æœ‰æ•ˆå¯†é’¥
                            </button>
                            <button class="btn btn-sm btn-outline-success dropdown-toggle dropdown-toggle-split" 
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                <span class="visually-hidden">Toggle Dropdown</span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="copyValidKeys('lines')">
                                    <i class="bi bi-list-ul"></i> æ¢è¡Œåˆ†éš”æ ¼å¼
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="copyValidKeys('comma')">
                                    <i class="bi bi-list"></i> é€—å·åˆ†éš”æ ¼å¼
                                </a></li>
                            </ul>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshKeyList()">
                                <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>å¯†é’¥</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æœ€åæ£€æµ‹</th>
                                        <th>é”™è¯¯ä¿¡æ¯</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="keyTableBody">
                                    <!-- åŠ¨æ€å†…å®¹ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" onerror="console.log('Bootstrap JS CDNåŠ è½½å¤±è´¥')"></script>
    <!-- å¤‡ç”¨CDN -->
    <script src="https://unpkg.com/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" onerror="this.remove()"></script>
    <!-- åº”ç”¨ä¿®å¤è„šæœ¬ -->
    <script src="/static/js/app-fixes.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let eventSource = null;
        let logContainer = document.getElementById('logContainer');
        let isCheckingGlobal = false;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initEventSource();
            refreshKeyList();
            
            // ç»‘å®šè¡¨å•äº‹ä»¶
            document.getElementById('addKeyForm').addEventListener('submit', addKeys);
            document.getElementById('scheduleForm').addEventListener('submit', saveSettings);
            
            // ä»£ç†å¼€å…³æ§åˆ¶
            const useProxyCheckbox = document.getElementById('useProxy');
            const proxyUrlContainer = document.getElementById('proxyUrlContainer');
            
            function updateProxyVisibility() {
                if (useProxyCheckbox.checked) {
                    proxyUrlContainer.style.display = 'block';
                    proxyUrlContainer.style.opacity = '1';
                } else {
                    proxyUrlContainer.style.display = 'block';
                    proxyUrlContainer.style.opacity = '0.5';
                    document.getElementById('proxyUrl').disabled = true;
                }
                // æ¢å¤å¯ç”¨çŠ¶æ€
                if (useProxyCheckbox.checked) {
                    document.getElementById('proxyUrl').disabled = false;
                }
            }
            
            useProxyCheckbox.addEventListener('change', updateProxyVisibility);
            updateProxyVisibility(); // åˆå§‹åŒ–çŠ¶æ€
            
            // é‚®ä»¶å¼€å…³æ§åˆ¶
            const emailEnabledCheckbox = document.getElementById('emailEnabled');
            const emailConfigContainer = document.getElementById('emailConfigContainer');
            
            function updateEmailVisibility() {
                const emailInputs = document.querySelectorAll('.email-input');
                if (emailEnabledCheckbox.checked) {
                    emailConfigContainer.style.display = 'block';
                    emailConfigContainer.style.opacity = '1';
                    emailInputs.forEach(input => input.disabled = false);
                    document.getElementById('emailPassword').disabled = false;
                } else {
                    emailConfigContainer.style.display = 'block';
                    emailConfigContainer.style.opacity = '0.5';
                    emailInputs.forEach(input => input.disabled = true);
                    document.getElementById('emailPassword').disabled = true;
                }
            }
            
            emailEnabledCheckbox.addEventListener('change', updateEmailVisibility);
            updateEmailVisibility(); // åˆå§‹åŒ–çŠ¶æ€
            
            // è®¾ç½®å®šæ—¶åˆ·æ–°
            setInterval(refreshKeyList, 10000);  // æ¯10ç§’åˆ·æ–°ä¸€æ¬¡
            setInterval(updateStats, 10000);      // æ¯10ç§’æ›´æ–°ç»Ÿè®¡
            
            // å¯åŠ¨çŠ¶æ€ç›‘æ§
            checkStatus();
            setInterval(checkStatus, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡çŠ¶æ€
            
            // å¯åŠ¨ç»Ÿè®¡ä¿¡æ¯æ›´æ–°
            setInterval(loadStats, 10000); // æ¯10ç§’æ›´æ–°ä¸€æ¬¡ç»Ÿè®¡
            
            // åˆå§‹åŒ–é‚®ç®±æ•°é‡æ˜¾ç¤ºå’Œç›‘å¬
            updateEmailCount();
            document.querySelectorAll('.email-input').forEach(input => {
                input.addEventListener('input', updateEmailCount);
            });
        });

        // åˆå§‹åŒ– Server-Sent Events
        function initEventSource() {
            if (eventSource) {
                eventSource.close();
            }
            
            eventSource = new EventSource('/logs');
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    if (!data.heartbeat) {
                        addLogEntry(data);
                    }
                } catch (e) {
                    console.error('è§£ææ—¥å¿—æ•°æ®å¤±è´¥:', e, event.data);
                }
            };
            
            eventSource.onopen = function(event) {
                console.log('æ—¥å¿—æµè¿æ¥å·²å»ºç«‹');
                document.getElementById('statusText').textContent = 'ç³»ç»Ÿè¿è¡Œä¸­ - æ—¥å¿—æµå·²è¿æ¥';
                document.getElementById('logStatus').textContent = 'å·²è¿æ¥';
                document.getElementById('logStatus').className = 'text-success ms-2';
            };
            
            eventSource.onerror = function(event) {
                console.log('æ—¥å¿—æµè¿æ¥é”™è¯¯ï¼Œ5ç§’åé‡è¿...');
                document.getElementById('statusText').textContent = 'ç³»ç»Ÿè¿è¡Œä¸­ - æ—¥å¿—æµè¿æ¥ä¸­æ–­';
                document.getElementById('logStatus').textContent = 'é‡è¿ä¸­...';
                document.getElementById('logStatus').className = 'text-warning ms-2';
                eventSource.close();
                setTimeout(initEventSource, 5000);
            };
        }

        // æ·»åŠ æ—¥å¿—æ¡ç›®
        function addLogEntry(logData) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯å¯æ›´æ–°çš„æ—¥å¿—ï¼ˆå¦‚è¿›åº¦æ¡ï¼‰
            if (logData.is_update && logData.update_id) {
                updateLogEntry(logData);
                return;
            }
            
            const logDiv = document.createElement('div');
            logDiv.className = 'log-entry';
            
            let levelClass = 'log-info';
            if (logData.level === 'ERROR') levelClass = 'log-error';
            else if (logData.message.includes('âœ…')) levelClass = 'log-success';
            else if (logData.message.includes('ğŸ“Š è¿›åº¦:')) levelClass = 'log-progress';
            
            logDiv.innerHTML = `<span class="text-muted">[${logData.timestamp}]</span> <span class="${levelClass}">${escapeHtml(logData.message)}</span>`;
            
            logContainer.appendChild(logDiv);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // å¦‚æœæ˜¯æ£€æµ‹ç›¸å…³çš„æ—¥å¿—ï¼Œç«‹å³æ›´æ–°ç»Ÿè®¡
            if (logData.message.includes('æ£€æµ‹') || logData.message.includes('ğŸ“Š è¿›åº¦:') || logData.message.includes('ğŸ‰')) {
                setTimeout(updateStats, 500); // å»¶è¿Ÿ500msæ›´æ–°ç»Ÿè®¡
            }
            
            // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡
            while (logContainer.children.length > 1000) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        // æ›´æ–°å¯æ›´æ–°çš„æ—¥å¿—æ¡ç›®
        function updateLogEntry(logData) {
            // æŸ¥æ‰¾å…·æœ‰ç›¸åŒupdate_idçš„æ—¥å¿—æ¡ç›®
            const existingEntry = document.querySelector(`[data-update-id="${logData.update_id}"]`);
            
            if (existingEntry) {
                // æ›´æ–°ç°æœ‰æ¡ç›®
                let levelClass = 'log-info';
                if (logData.level === 'ERROR') levelClass = 'log-error';
                else if (logData.message.includes('âœ…')) levelClass = 'log-success';
                else if (logData.message.includes('ğŸ“Š è¿›åº¦:')) levelClass = 'log-progress';
                
                existingEntry.innerHTML = `<span class="text-muted">[${logData.timestamp}]</span> <span class="${levelClass}">${escapeHtml(logData.message)}</span>`;
                
                // å¦‚æœæ˜¯æ£€æµ‹ç›¸å…³çš„æ—¥å¿—ï¼Œç«‹å³æ›´æ–°ç»Ÿè®¡
                if (logData.message.includes('ğŸ“Š è¿›åº¦:')) {
                    setTimeout(updateStats, 500);
                }
            } else {
                // å¦‚æœæ‰¾ä¸åˆ°ç°æœ‰æ¡ç›®ï¼Œåˆ›å»ºæ–°çš„ï¼ˆç¬¬ä¸€æ¬¡ï¼‰
                const logDiv = document.createElement('div');
                logDiv.className = 'log-entry';
                logDiv.setAttribute('data-update-id', logData.update_id);
                
                let levelClass = 'log-progress'; // å¯æ›´æ–°çš„é€šå¸¸æ˜¯è¿›åº¦æ¡
                logDiv.innerHTML = `<span class="text-muted">[${logData.timestamp}]</span> <span class="${levelClass}">${escapeHtml(logData.message)}</span>`;
                
                logContainer.appendChild(logDiv);
                logContainer.scrollTop = logContainer.scrollHeight;
                
                setTimeout(updateStats, 500);
            }
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            logContainer.innerHTML = '';
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ·»åŠ å¯†é’¥
        async function addKeys(event) {
            event.preventDefault();
            
            const textarea = document.getElementById('newKeys');
            const keys = textarea.value.trim().split('\n').filter(key => key.trim());
            
            if (keys.length === 0) {
                alert('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªå¯†é’¥');
                return;
            }
            
            try {
                const response = await fetch('/api/keys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keys: keys })
                });
                
                const result = await response.json();
                if (result.success) {
                    textarea.value = '';
                    // ç«‹å³åˆ·æ–°ç•Œé¢
                    setTimeout(() => {
                        refreshKeyList();
                        updateStats();
                    }, 1000);  // å»¶è¿Ÿ1ç§’è®©æ£€æµ‹å¼€å§‹
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    addLogEntry({
                        timestamp: new Date().toLocaleString(),
                        level: 'INFO',
                        message: `å·²æ·»åŠ  ${result.added_count} ä¸ªå¯†é’¥ï¼Œå¼€å§‹æ£€æµ‹...`
                    });
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æ·»åŠ å¤±è´¥: ' + error.message);
            }
        }

        // ä¿å­˜è®¾ç½®
        async function saveSettings(event) {
            event.preventDefault();
            
            const intervalMinutes = parseInt(document.getElementById('intervalMinutes').value);
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const useProxy = document.getElementById('useProxy').checked;
            const proxyUrl = document.getElementById('proxyUrl').value;
            const concurrency = parseInt(document.getElementById('concurrency').value);
            const checkStrategy = document.getElementById('checkStrategy').value;
            const emailEnabled = document.getElementById('emailEnabled').checked;
            const email1 = document.getElementById('email1').value.trim();
            const email2 = document.getElementById('email2').value.trim();
            const email3 = document.getElementById('email3').value.trim();
            const emailPassword = document.getElementById('emailPassword').value;
            
            // éªŒè¯å¹¶å‘æ•°èŒƒå›´
            if (concurrency < 1 || concurrency > 100) {
                alert('å¹¶å‘æ•°å¿…é¡»åœ¨ 1-100 ä¹‹é—´');
                return;
            }
            
            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        check_interval: intervalMinutes,
                        api_url: apiUrl,
                        use_proxy: useProxy ? 'true' : 'false',
                        proxy_url: proxyUrl,
                        concurrency: concurrency,
                        check_strategy: checkStrategy,
                        email_enabled: emailEnabled ? 'true' : 'false',
                        email1: email1,
                        email2: email2,
                        email3: email3,
                        email_password: emailPassword
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('è®¾ç½®å·²ä¿å­˜');
                    const strategyText = checkStrategy === 'all' ? 'å…¨é‡æ£€æµ‹' : 'å¢é‡æ£€æµ‹';
                    const apiText = apiUrl ? `è‡ªå®šä¹‰API: ${apiUrl}` : 'ä½¿ç”¨Googleå®˜æ–¹API';
                    const proxyText = useProxy ? `ä»£ç†: ${proxyUrl}` : 'ä¸ä½¿ç”¨ä»£ç†';
                    const emailCount = getConfiguredEmailCount();
                    const emailText = emailEnabled ? `é‚®ä»¶é€šçŸ¥: ${emailCount}ä¸ªé‚®ç®±` : 'é‚®ä»¶é€šçŸ¥: å·²ç¦ç”¨';
                    // æ˜¾ç¤ºè®¾ç½®æ›´æ–°çš„æ—¥å¿—
                    addLogEntry({
                        timestamp: new Date().toLocaleString(),
                        level: 'INFO',
                        message: `âš™ï¸ è®¾ç½®å·²æ›´æ–° - æ£€æµ‹é—´éš”: ${intervalMinutes}åˆ†é’Ÿ, ${apiText}, ${proxyText}, ${emailText}, å¹¶å‘æ•°: ${concurrency}, ç­–ç•¥: ${strategyText}`
                    });
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        // æ£€æµ‹æ‰€æœ‰å¯†é’¥
        function checkAllKeys(forceAll = false) {
            // æ£€æŸ¥å½“å‰çŠ¶æ€
            if (isCheckingGlobal) {
                showAlert('æ£€æµ‹è¢«è·³è¿‡ï¼šå¦ä¸€ä¸ªæ£€æµ‹è¿›ç¨‹æ­£åœ¨è¿è¡Œä¸­', 'warning');
                return;
            }
            
            const url = '/api/check-all';
            const data = { force_all: forceAll };
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                    // ç«‹å³æ£€æŸ¥çŠ¶æ€
                    setTimeout(checkStatus, 100);
                } else {
                    showAlert(data.message, data.is_checking ? 'warning' : 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('æ£€æµ‹è¯·æ±‚å¤±è´¥', 'danger');
            });
        }

        // æ£€æµ‹å•ä¸ªå¯†é’¥
        function checkSingleKey(keyValue) {
            // æ£€æŸ¥å½“å‰çŠ¶æ€
            if (isCheckingGlobal) {
                showAlert('æ£€æµ‹è¢«è·³è¿‡ï¼šå¦ä¸€ä¸ªæ£€æµ‹è¿›ç¨‹æ­£åœ¨è¿è¡Œä¸­', 'warning');
                return;
            }
            
            fetch('/api/check-single', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ key: keyValue })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                    // ç«‹å³æ£€æŸ¥çŠ¶æ€
                    setTimeout(checkStatus, 100);
                } else {
                    showAlert(data.message, data.is_checking ? 'warning' : 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('æ£€æµ‹è¯·æ±‚å¤±è´¥', 'danger');
            });
        }

        // åˆ·æ–°å¯†é’¥åˆ—è¡¨
        async function refreshKeyList() {
            try {
                const response = await fetch('/api/keys');
                const keys = await response.json();
                
                const tbody = document.getElementById('keyTableBody');
                tbody.innerHTML = '';
                
                keys.forEach(key => {
                    const row = document.createElement('tr');
                    
                    let statusBadge = '';
                    switch (key.status) {
                        case 'valid':
                            statusBadge = '<span class="badge bg-success status-badge">æœ‰æ•ˆ</span>';
                            break;
                        case 'invalid':
                            statusBadge = '<span class="badge bg-danger status-badge">æ— æ•ˆ</span>';
                            break;
                        case 'pending':
                            statusBadge = '<span class="badge bg-warning status-badge">å¾…æ£€æµ‹</span>';
                            break;
                        default:
                            statusBadge = '<span class="badge bg-secondary status-badge">æœªçŸ¥</span>';
                    }
                    
                    const lastChecked = key.last_checked ? new Date(key.last_checked).toLocaleString() : 'ä»æœª';
                    const errorMessage = key.error_message || '';
                    
                    row.innerHTML = `
                        <td class="key-display">${key.key_value.substring(0, 10)}...${key.key_value.substring(key.key_value.length - 4)}</td>
                        <td>${statusBadge}</td>
                        <td><small>${lastChecked}</small></td>
                        <td><small class="text-danger">${errorMessage}</small></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="checkSingleKey('${key.key_value}')">
                                <i class="bi bi-check-circle"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteKey(${key.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                updateStats();
            } catch (error) {
                console.error('åˆ·æ–°å¯†é’¥åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // åˆ é™¤å¯†é’¥
        async function deleteKey(keyId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯†é’¥å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/keys/${keyId}`, { method: 'DELETE' });
                const result = await response.json();
                if (result.success) {
                    refreshKeyList();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        async function updateStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                document.getElementById('validCount').textContent = stats.valid_count;
                document.getElementById('invalidCount').textContent = stats.invalid_count;
                document.getElementById('pendingCount').textContent = stats.pending_count;
            } catch (error) {
                console.error('æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // æ£€æµ‹çŠ¶æ€ç›‘æ§
        function checkStatus() {
            fetch('/api/check-status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateCheckStatus(data.status);
                    }
                })
                .catch(error => {
                    console.error('è·å–æ£€æµ‹çŠ¶æ€å¤±è´¥:', error);
                });
        }
        
        // æ›´æ–°æ£€æµ‹çŠ¶æ€æ˜¾ç¤º
        function updateCheckStatus(status) {
            const isChecking = status.is_checking;
            const stopRequested = status.stop_requested;
            isCheckingGlobal = isChecking;
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            const idleElement = document.getElementById('status-idle');
            const checkingElement = document.getElementById('status-checking');
            const stopStatusElement = document.getElementById('stop-status');
            const stopBtn = document.getElementById('stop-check-btn');
            
            if (isChecking) {
                idleElement.classList.add('d-none');
                checkingElement.classList.remove('d-none');
                
                // æ›´æ–°æ£€æµ‹ç±»å‹å’ŒæŒç»­æ—¶é—´
                document.getElementById('check-type').textContent = status.check_type || 'æ­£åœ¨æ£€æµ‹...';
                document.getElementById('check-duration').textContent = `è¿è¡Œæ—¶é—´: ${status.duration}ç§’`;
                
                // å¤„ç†åœæ­¢çŠ¶æ€
                if (stopRequested) {
                    stopStatusElement.classList.remove('d-none');
                    stopBtn.disabled = true;
                    stopBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> åœæ­¢ä¸­';
                } else {
                    stopStatusElement.classList.add('d-none');
                    stopBtn.disabled = false;
                    stopBtn.innerHTML = '<i class="bi bi-stop-fill"></i> åœæ­¢';
                }
            } else {
                idleElement.classList.remove('d-none');
                checkingElement.classList.add('d-none');
                stopStatusElement.classList.add('d-none');
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateButtonStates(isChecking);
        }
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtonStates(isChecking) {
            // æ£€æµ‹ç›¸å…³æŒ‰é’®
            const checkAllBtn = document.getElementById('check-all-btn');
            const forceCheckBtn = document.getElementById('force-check-btn');
            
            if (checkAllBtn) {
                checkAllBtn.disabled = isChecking;
                checkAllBtn.innerHTML = isChecking ? 
                    '<span class="spinner-border spinner-border-sm me-1"></span>æ£€æµ‹ä¸­...' : 
                    'ğŸ” æ£€æµ‹æ‰€æœ‰å¯†é’¥';
            }
            
            if (forceCheckBtn) {
                forceCheckBtn.disabled = isChecking;
                forceCheckBtn.innerHTML = isChecking ? 
                    '<span class="spinner-border spinner-border-sm me-1"></span>æ£€æµ‹ä¸­...' : 
                    'ğŸ”¥ å¼ºåˆ¶å…¨é‡æ£€æµ‹';
            }
            
            // å•ä¸ªå¯†é’¥æ£€æµ‹æŒ‰é’®
            const singleCheckBtns = document.querySelectorAll('.btn-check-single');
            singleCheckBtns.forEach(btn => {
                btn.disabled = isChecking;
                if (isChecking) {
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
                } else {
                    btn.innerHTML = 'ğŸ”';
                }
            });
        }

        // åœæ­¢æ£€æµ‹
        function stopChecking() {
            // æ£€æŸ¥å½“å‰çŠ¶æ€
            if (!isCheckingGlobal) {
                alert('å½“å‰æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„æ£€æµ‹');
                return;
            }
            
            // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            if (!confirm('ç¡®å®šè¦åœæ­¢å½“å‰æ£€æµ‹å—ï¼Ÿå·²å®Œæˆçš„æ£€æµ‹ç»“æœå°†ä¼šä¿å­˜ã€‚')) {
                return;
            }
            
            fetch('/api/stop-check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    // ç«‹å³æ£€æŸ¥çŠ¶æ€æ›´æ–°
                    setTimeout(checkStatus, 100);
                } else {
                    alert('åœæ­¢å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('åœæ­¢è¯·æ±‚å¤±è´¥');
            });
        }
        
        // å‘é€æµ‹è¯•é‚®ä»¶
        async function sendTestEmail() {
            const emailPassword = document.getElementById('emailPassword').value;
            const configuredEmails = getConfiguredEmails();
            
            if (configuredEmails.length === 0 || !emailPassword) {
                alert('è¯·è‡³å°‘è®¾ç½®ä¸€ä¸ªé‚®ç®±åœ°å€å¹¶å¡«å†™Gmailåº”ç”¨å¯†ç ');
                return;
            }
            
            // éªŒè¯é‚®ç®±æ ¼å¼
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const invalidEmails = configuredEmails.filter(email => !emailRegex.test(email));
            if (invalidEmails.length > 0) {
                alert(`ä»¥ä¸‹é‚®ç®±åœ°å€æ ¼å¼æ— æ•ˆ: ${invalidEmails.join(', ')}`);
                return;
            }
            
            const button = event.target;
            const originalText = button.innerHTML;
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                button.innerHTML = '<i class="bi bi-hourglass-split"></i> å‘é€ä¸­...';
                button.disabled = true;
                
                const response = await fetch('/api/test-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        receiver_email: configuredEmails[0], // ä¼ é€’ç¬¬ä¸€ä¸ªé‚®ç®±åšå…¼å®¹æ€§
                        app_password: emailPassword
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    addLogEntry({
                        timestamp: new Date().toLocaleString(),
                        level: 'INFO',
                        message: `ğŸ“§ ${result.message}`
                    });
                } else {
                    alert('æµ‹è¯•é‚®ä»¶å‘é€å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                alert('æµ‹è¯•é‚®ä»¶å‘é€å¤±è´¥: ' + error.message);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
        
        // æ›´æ–°é‚®ç®±æ•°é‡æ˜¾ç¤º
        function updateEmailCount() {
            const count = getConfiguredEmailCount();
            const countBadge = document.getElementById('emailCount');
            countBadge.textContent = count;
            
            // æ ¹æ®æ•°é‡æ›´æ–°æ ·å¼
            countBadge.className = `badge ${count > 0 ? 'bg-success' : 'bg-secondary'}`;
        }
        
        // è·å–å·²é…ç½®çš„é‚®ç®±åˆ—è¡¨
        function getConfiguredEmails() {
            const emails = [];
            for (let i = 1; i <= 3; i++) {
                const email = document.getElementById(`email${i}`).value.trim();
                if (email) {
                    emails.push(email);
                }
            }
            return emails;
        }
        
        // è·å–å·²é…ç½®é‚®ç®±æ•°é‡
        function getConfiguredEmailCount() {
            return getConfiguredEmails().length;
        }
        
        // å¤åˆ¶æœ‰æ•ˆå¯†é’¥
        async function copyValidKeys(format) {
            try {
                const response = await fetch(`/api/valid-keys?format=${format}`);
                const result = await response.json();
                
                if (!result.success) {
                    alert('è·å–æœ‰æ•ˆå¯†é’¥å¤±è´¥: ' + result.message);
                    return;
                }
                
                if (result.count === 0) {
                    alert('æ²¡æœ‰æœ‰æ•ˆçš„å¯†é’¥å¯å¤åˆ¶');
                    return;
                }
                
                // ä½¿ç”¨Clipboard APIå¤åˆ¶
                if (navigator.clipboard) {
                    await navigator.clipboard.writeText(result.content);
                    alert(`å·²å¤åˆ¶ ${result.count} ä¸ªæœ‰æ•ˆå¯†é’¥ï¼ˆ${format === 'comma' ? 'é€—å·åˆ†éš”' : 'æ¢è¡Œåˆ†éš”'}æ ¼å¼ï¼‰`);
                } else {
                    // é™çº§æ–¹æ¡ˆï¼šåˆ›å»ºä¸´æ—¶æ–‡æœ¬æ¡†
                    const textArea = document.createElement('textarea');
                    textArea.value = result.content;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert(`å·²å¤åˆ¶ ${result.count} ä¸ªæœ‰æ•ˆå¯†é’¥ï¼ˆ${format === 'comma' ? 'é€—å·åˆ†éš”' : 'æ¢è¡Œåˆ†éš”'}æ ¼å¼ï¼‰`);
                }
            } catch (error) {
                console.error('å¤åˆ¶å¤±è´¥:', error);
                alert('å¤åˆ¶å¤±è´¥: ' + error.message);
            }
        }
    </script>
</body>
</html> 