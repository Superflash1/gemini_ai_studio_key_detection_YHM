## v4.0 项目解析（Gemini API Key Checker）

本解析基于 `v4.0/` 下的源代码（未阅读本目录下任何 Markdown 文档），对技术栈、架构、各文件职责、运行流程、接口与配置信息进行完整说明，并给出改进建议。

---

### 一、技术栈总览
- 后端框架：Flask（`flask`）
- ORM 与数据库：Flask SQLAlchemy（`flask_sqlalchemy`）+ SQLite，WAL 模式与 PRAGMA 优化
- 任务调度：APScheduler（后台调度 + 持续 pending 轮询）
- 并发模型：`concurrent.futures.ThreadPoolExecutor`（可配置并发数）
- 日志推送：Server-Sent Events（SSE）实时日志流（自定义 `logging.Handler` + 队列）
- 邮件通知：`smtplib` + `email` 标准库，代理能力由 `PySocks`（socks、http 代理）提供
- Key 校验：
  - Google 官方 SDK：`google-generativeai`（`list_models` 触发请求）
  - 自定义 API URL：`requests` 直连（支持代理）
- 前端：
  - `templates/index.html`（Jinja2 模板）
  - 样式：Bootstrap（CDN + 本地后备 `static/css/local-bootstrap.css`）、自定义样式 `static/css/app.css`
  - 交互：`static/js/app.js`（主逻辑）、`static/js/app-fixes.js`（兜底修复/增强）
- 脚本与容器化：
  - 构建/部署脚本：`scripts/build.sh`、`scripts/deploy.sh`
  - `.dockerignore` 提供构建忽略规则（包含 `*.md` 白名单仅 `README.md`）
- 运行环境：`.python-version` 指定 3.11；`requirements.txt` 依赖清单；`pyproject.toml` 最小元信息

---

### 二、整体架构图

```
[Browser/Frontend]
  - templates/index.html
  - static/js/app.js, app-fixes.js
  - static/css/*
       |
       | HTTP + SSE
       v
[Flask app.py]
  |-- /api/* (业务路由)
  |-- /logs (SSE)
  |-- SQLAlchemy --> (SQLite: instance/gemini_keys.db)
  |-- 初始化:
       - KeyChecker (scheduler.py)
       - EmailNotifier (email_notifier.py)

KeyChecker (scheduler.py)
  |-- Interval/手动触发
  |-- 并发: ThreadPoolExecutor
  |-- 调用: check_key() -> gemini_key_checker/checker.py
  |             |-- 官方 SDK: google-generativeai
  |             |-- 自定义 URL: requests -> 外部 API 端点
  |-- 日志 -> SSE 队列
  |-- 结果 -> 数据库
  |-- 完成 -> 可选邮件通知

EmailNotifier (email_notifier.py)
  |-- SMTP (可走 PySocks 代理) -> 收件人邮箱
```

---

### 三、数据模型关系图

```
[API_KEYS]
  - id (PK)
  - key_value (UK, index)
  - status: pending|valid|invalid|error
  - last_checked
  - error_message
  - created_at
  - updated_at

[CHECK_LOGS]
  - id (PK)
  - api_key_id (FK -> API_KEYS.id)
  - status: valid|invalid|error
  - message
  - checked_at

[SETTINGS]
  - id (PK)
  - key (UK)
  - value
  - description
  - updated_at

关系:
  API_KEYS 1 -- * CHECK_LOGS
```

---

#### 数据结构定义位置与结构补充
- 数据库模型定义（持久层）
  - 文件：`v4.0/models.py`
  - 类：
    - `ApiKey`：字段同上数据模型图；关键关系：`check_logs = db.relationship('CheckLog', ..., cascade='all, delete-orphan')`
    - `CheckLog`：外键 `api_key_id -> api_keys.id`
    - `Settings`：键值对配置项
- 默认配置项集合（应用初始化）
  - 文件：`v4.0/app.py`，函数：`create_tables()` 中 `default_settings` 字典，包含：
    - `check_interval`、`proxy_url`、`use_proxy`、`api_url`、`concurrency`、`email_enabled`、`email1`、`email2`、`email3`、`email_password`、`email_triggers`
- 日志/SSE 数据帧结构（前后端实时日志）
  - 产生位置：`v4.0/scheduler.py` 内部 `LogHandler.emit()` 与 `get_log_stream()`
  - 字段：
    - `timestamp`、`level`、`message`，可选：`update_id`、`is_update`；心跳帧：`{"heartbeat": true}`
- 检测结果返回结构（校验函数）
  - 文件：`v4.0/gemini_key_checker/checker.py`
  - 函数：`check_key(...) -> tuple[bool, str]`；辅助 `_check_key_with_custom_url(...)`、`_check_key_with_genai_sdk(...)` 同样返回 `(是否有效, 说明)`
- 邮件报告数据结构（通知内容）
  - 组装位置：`v4.0/scheduler.py` 的 `_send_email_notification()`，`check_results` 字段：
    - `total`、`valid`、`invalid`、`processed`、`start_time`、`duration`、`stopped`
- 常用 API 响应结构（接口返回体关键字段）
  - `GET /api/keys`（`app.py/get_keys`）：`[{id,key_value,status,last_checked,error_message,created_at}]`
  - `GET /api/stats`（`app.py/get_stats`）：`{valid_count,invalid_count,pending_count,total_count}`
  - `GET /api/valid-keys`（`app.py/get_valid_keys`）：`{success,count,format,content}`
  - `GET /api/check-status`（`app.py/get_check_status`）：`{success, status:{is_checking,check_type,start_time,duration,stop_requested}}`

### 四、逐文件职责说明（v4.0/）

- app.py
  - Flask 应用入口与配置：SQLite 连接、`SECRET_KEY`、SQLAlchemy Engine Options。
  - 通过 `@event.listens_for(Engine, "connect")` 为 SQLite 启用 WAL、synchronous、temp_store、foreign_keys 等 PRAGMA，提高并发可靠性。
  - `create_tables()`：建表、写入默认 `Settings`、初始化 `EmailNotifier` 与 `KeyChecker` 调度器并启动、按 `check_interval` 注册周期任务。
  - 路由：
    - 页面：`/`（渲染控制台页面）。
    - SSE：`/logs` 推送实时日志。
    - Keys：`GET /api/keys`、`POST /api/keys`（支持文本/数组、自动拆分去重）、`DELETE /api/keys/<id>`、`POST /api/keys/delete-invalid`。
    - 检测：`POST /api/check-single`、`POST /api/check-all`（支持强制全量）、`POST /api/check-pending`、`POST /api/stop-check`、`GET /api/check-status`。
    - 统计与导出：`GET /api/stats`、`GET /api/valid-keys?format=lines|comma`。
    - 设置：`POST /api/settings`（间隔/并发/代理/API URL/策略/邮件等）。
    - 邮件：`POST /api/test-email`（多收件人测试）。
  - 线程化触发：新增密钥后后台触发 pending 并发检测。
  - 优雅关闭：`atexit` 停止调度器。

- scheduler.py
  - `KeyChecker`：核心检测调度/并发执行组件。
    - 后台调度器 `BackgroundScheduler`；支持“定时全量/增量检测”与“持续 pending 检测”（每 30 秒扫描 pending）。
    - 并发检测：基于 `ThreadPoolExecutor(max_workers=concurrency)`；支持用户停止，优雅取消剩余任务。
    - 日志：自定义 `LogHandler` 将日志写入全局队列，前端通过 SSE 增量刷新；提供单行可更新的“ASCII 进度条”。
    - 结果入库：更新 `ApiKey` 状态与 `CheckLog` 记录，commit 后统计并触发可选邮件通知。
    - 设置读取：`proxy_url`、`use_proxy`、`api_url`、`concurrency`、`check_strategy(all|incremental)`。
  - 全局方法：`init_scheduler(app)` 返回全局 `key_checker`；`get_log_stream()` 作为 SSE 源。

- email_notifier.py
  - `EmailNotifier`：支持直连与通过 `PySocks` 代理（HTTP/SOCKS4/SOCKS5）连接 Gmail SMTP。
  - 读取数据库 `Settings` 的开关、代理和收件人邮箱（`email1..3`），批量发送 HTML+Text 双格式邮件。
  - 提供测试邮件与检测结果邮件（含统计、进度与停止状态说明）。

- models.py
  - `ApiKey`、`CheckLog`、`Settings` 三个模型与关系定义；`CheckLog` 与 `ApiKey` 关联，`Settings` 存放全部运行时配置。

- start_web.py
  - 进程启动脚本：打印欢迎信息，调用 `create_tables()` 后启动 Flask，关闭重载避免调度器重复启动。

- run.py
  - CLI 批量检测入口：支持命令行传 key 或 `-f/--file`，配置并发、代理/禁用代理，调用 `gemini_key_checker.main.process_keys`，将结果写入 `valid_keys.txt` 与 `invalid_keys.txt`。

- main.py
  - 简单占位（打印 “Hello from new!”）。

- gemini_key_checker/
  - checker.py：`check_key()` 核心校验逻辑。
    - 若提供自定义 `api_url`：使用 `requests` GET `{api_url}/v1/models`（或补全路径），带 `Authorization: Bearer <key>`；解析 200 响应判断是否包含模型数据；处理 401/403/404/网络错误等。
    - 否则：使用 `google-generativeai` SDK `list_models`，基于异常类型返回具体失败原因。
    - 支持通过环境变量/requests 代理。
  - main.py：`process_keys()` 并发检测 + `tqdm` 进度条，控制台输出，结果写文件。
  - __init__.py：包标记。

- static/js/
  - app.js：
    - 绑定 UI 行为：添加/删除/检测/停止/复制有效 key、保存设置、状态更新。
    - SSE `/logs` 日志消费：识别可更新日志帧（进度条 update_id），滚动与剪裁。
    - 统计卡片与徽章动态刷新；邮箱数量统计与测试邮件；网络请求与错误提示。
  - app-fixes.js：
    - 兜底增强：提供 `showAlert`、本地 Bootstrap 后备、邮箱数量修复、下拉菜单修复、网络状态检测、请求超时静默处理、错误降噪、静默模式等。

- static/css/
  - app.css：轻玻璃拟态风格、统一按钮规范、表格/表单/侧栏/统计进度等样式优化。
  - local-bootstrap.css：Bootstrap 的本地最小替代样式，用于 CDN 不可用时保证基本可用。

- templates/
  - index.html：单页控制台界面（Jinja2 注入 `stats`、`settings`），支持操作区、统计卡、实时日志与列表表格、设置模态框等；CDN 与本地 CSS/JS 双路径降级方案。

- scripts/
  - build.sh：本地 Docker 镜像构建（名称/标签可配，基础测试：`python -c "import app"`）。
  - deploy.sh：快速部署容器（镜像检查/构建、容器重建、卷挂载到 `/app/instance`、启动与健康等待、可选日志跟随）。

- instance/
  - SQLite 运行期文件（`gemini_keys.db-*`）。数据库实际路径由 `SQLALCHEMY_DATABASE_URI = 'sqlite:///gemini_keys.db'` 决定。

- 其他：
  - .dockerignore：构建忽略规则（忽略多类缓存、日志、测试、`*.md` 但放行 `README.md`、数据库与 Docker 文件等）。
  - .python-version：`3.11`。
  - requirements.txt：项目依赖清单。
  - pyproject.toml：项目最小元数据与 Python 版本约束。
  - Dockerfile、docker-compose.yml：目录索引显示存在（若缺失则以脚本为准），作用分别为镜像构建与编排（未阅读其内容）。

---

### 五、核心运行流程（Web）
1) 启动：
   - 运行 `python start_web.py` 或 `python app.py`。
   - 初始化数据库与默认 `Settings`，启动 `KeyChecker` 与持续 pending 检测任务（30 秒一次）。
2) 添加密钥：
   - 前端提交到 `POST /api/keys`，后端去重落库为 `pending`，后台线程触发 pending 并发检测。
3) 并发检测：
   - `KeyChecker` 读取 `Settings`（代理/并发/策略/API URL），按策略获取待检集合；使用线程池并发调用 `check_key()`。
   - `check_key()` 走 SDK 或自定义 API URL，两种路径互斥；返回有效性与原因。
   - 实时日志通过 SSE 推送，单行进度条动态刷新。
   - 结束后更新统计，若启用邮件通知则异步发送报告（支持多收件人、代理 SMTP）。
4) 运维：
   - 后台定时任务按 `check_interval` 周期执行全量/增量检测；持续任务自动处理新增 `pending`。

---

### 六、接口一览（主要 API）
- 页面与日志
  - `GET /`：控制台页面
  - `GET /logs`：SSE 实时日志
- Key 管理
  - `GET /api/keys`：列出全部密钥
  - `POST /api/keys`：批量添加（支持换行/逗号/数组）
  - `DELETE /api/keys/<id>`：删除指定密钥
  - `POST /api/keys/delete-invalid`：批量删除无效密钥
- 检测控制
  - `POST /api/check-single`：检测单个
  - `POST /api/check-all`：检测所有（可 `force_all`）
  - `POST /api/check-pending`：仅检测 `pending`
  - `POST /api/stop-check`：优雅停止当前检测
  - `GET /api/check-status`：检测状态（是否运行、类型、时长、停止中）
- 统计与导出
  - `GET /api/stats`：统计卡片数据
  - `GET /api/valid-keys?format=lines|comma`：导出有效密钥
- 设置与邮件
  - `POST /api/settings`：保存运行参数（间隔/并发/策略/代理/API URL/邮件等）
  - `POST /api/test-email`：发送测试邮件

---

### 七、配置与默认值（Settings 表关键项）
- `check_interval`：默认 `60` 分钟
- `proxy_url`：默认 `http://127.0.0.1:7890`
- `use_proxy`：默认 `false`（注意：前端默认勾选的逻辑与后端默认值需对齐）
- `api_url`：空表示使用官方 SDK
- `concurrency`：默认 `100`
- `check_strategy`：未显式初始化（默认全量 all，代码兜底）
- 邮件相关：`email_enabled` 默认 `true`；`email1..3`；`email_password`；触发字段 `email_triggers`（当前仅 completion 场景）

---

### 八、可靠性与安全性要点
- SQLite 并发：已启用 WAL 与合理 PRAGMA；`check_same_thread=False` 支持多线程；同时注意高并发写入时的延迟与锁等待。
- 线程与停止：通过 `_stop_requested` 标志与取消剩余 future 的方式实现优雅停止；进度强制刷新。
- SSE：采用心跳保持连接；前端断线自动重连。
- 代理：HTTP/SOCKS 均可；自定义 API URL 与 SMTP 都支持代理；Windows 网络超时（WinError 10060）有特判提示。
- 凭据管理：
  - `SECRET_KEY` 与发件邮箱、应用密码应改为环境变量/容器 `secret` 注入，不应硬编码或存库明文。
  - `EmailNotifier.sender_email` 目前硬编码为 Gmail 地址。
- 输入校验：`/api/keys` 做了基本清洗；自定义 `api_url` 建议做白名单或格式校验，避免 SSRF 风险。
- 资源控制：并发默认 100，建议根据机器与目标 API 限流策略调优。

---

### 九、部署与运行
- 本地运行：
  - `python start_web.py`（推荐，避免重载导致调度器重复）
  - 或 `python app.py`
- 容器化：
  - `scripts/build.sh` 构建镜像；`scripts/deploy.sh` 一键部署，绑定数据卷至 `/app/instance`，端口默认 5000。
  - `.dockerignore` 已优化构建上下文体积。
- 依赖安装：`pip install -r requirements.txt`

---

### 十、可改进建议
- 安全
  - 使用环境变量/Secret 管理 `SECRET_KEY`、发件邮箱、应用密码；邮件密码不建议持久化在数据库明文。
  - 对 `api_url` 做更严格的校验（协议、域名白名单、路径约束）以降低 SSRF 风险。
- 稳定性
  - 增加任务级重试与退避（对网络/超时类错误）。
  - 针对 `google-generativeai` 请求增加速率限制与节流（避免触发配额/限流）。
- 可观测性
  - `/healthz` 健康检查（数据库可用、调度器状态）。
  - 记录每批检测的聚合统计到 `CheckLog` 或新增批次表，便于历史回溯。
- 体验
  - 导出有效密钥提供下载文件接口；
  - 列表分页与搜索过滤；
  - `check_strategy` 在设置页增加 UI 默认值与说明。
- 运维/容器
  - 在 Dockerfile 中添加 `HEALTHCHECK`；
  - `docker-compose.yml` 可提供反向代理（如 Nginx）与环境变量注入样例；
  - 将并发/间隔等映射为环境变量默认值，容器首启即可配置。

---

### 十一、快速认知（给新同学）
- 打开方式：启动后访问 `http://localhost:5000`。
- 常用操作：左侧按钮区“检测所有/只检测待检测/强制全量/停止检测”、复制有效 key、删除无效 key。
- 设置页：间隔/并发/策略、代理、自定义 API URL、邮件通知（多收件人、SMTP 走代理）。
- 实时反馈：顶部状态 + SSE 日志进度条。

如需更深入的设计/实现细节，可直接从 `app.py`、`scheduler.py`、`email_notifier.py` 与 `gemini_key_checker/checker.py` 四处切入阅读。 